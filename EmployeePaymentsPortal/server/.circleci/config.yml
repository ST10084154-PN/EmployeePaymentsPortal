version: 2.1
jobs:
  build:
    docker:
      - image: cimg/node:20.11
    steps:
      - checkout
      - run: cd server && npm ci
      - run: cd server && npm run test || true
      - run: cd server && npm run audit || true
      - run:
          name: Run SonarQube Scan (if token set)
          command: |
            if [ -z "$SONAR_TOKEN" ]; then echo "SONAR_TOKEN not set, skipping sonar scan"; exit 0; fi
            npm install -g sonarqube-scanner
            sonar-scanner -Dsonar.projectKey=employee-payments-portal -Dsonar.sources=./server -Dsonar.host.url=https://sonarcloud.io -Dsonar.login=$SONAR_TOKEN
workflows:
  version: 2
  main:
    jobs:
      - build
